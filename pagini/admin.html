<!DOCTYPE html>
<html lang="ro">

<head>
    <meta charset="UTF-8">
    <title>Admin - Panou</title>
    <script src="../scripts/admin.js" defer></script>
</head>

<body>
    <h2>Panou Admin</h2>
    <div id="adminInfo"></div>
    <button id="logoutBtn">Deconectare</button>

    <h2>Toți userii</h2>
    <div id="users"></div>

    <h2>Toate comentariile</h2>
    <div id="coms"></div>

    <a href="produse.html">Produse</a>

    <h2>Adaugă / Editează produs</h2>
    <form id="prodForm">
        <input type="file" id="imagine" accept="image/*"><br>
        <input type="text" id="denumire" placeholder="Denumire" required><br>
        <input type="number" id="pret" placeholder="Pret" required><br>
        <input type="text" id="descriere" placeholder="Descriere" required><br>
        <input type="number" id="cantitate" placeholder="Cantitate kg" required><br>
        <input type="text" id="sloiuri" placeholder="Sloiuri separate prin virgula" required><br>
        <button type="submit">Adauga / Salveaza</button>
    </form>

    <h2>Lista produse</h2>
    <div id="produseList"></div>

    <script>
        const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxBfrTMSIv_HXNc7WLwUwWnMKCW-K7rjxA9Cql-mexVhW29Ug7Uy5cvrpqHjpGsn10Kpg/exec";
        let produse = [];
        let editId = null;

        // incarcare produse
        async function incarcaProduse() {
            const res = await fetch(WEBAPP_URL);
            produse = await res.json();
            afiseazaProduse();
        }

        // afiseaza produse
        function afiseazaProduse() {
            const list = document.getElementById("produseList");
            list.innerHTML = "";
            produse.forEach(p => {
                const div = document.createElement("div");
                div.innerHTML = `
            <strong>ID:</strong> ${p.id}<br>
            <img src="${p.imagine}" width="100"><br>
            <strong>${p.denumire}</strong> - ${p.pret} Lei<br>
            ${p.descriere}<br>
            Cantitate: ${p.cantitate} kg<br>
            Sloiuri: ${p.sloiuri.join(", ")}<br>
            <button onclick="incepeEdit(${p.id})">Editeaza</button>
            <button onclick="sterge(${p.id})">Sterge</button>
            <hr>
        `;
                list.appendChild(div);
            });
        }

        // sterge produs
        async function sterge(id) {
            const res = await fetch(WEBAPP_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ action: "sterge", id })
            });
            await res.json();
            incarcaProduse();
        }

        // incepe edit
        function incepeEdit(id) {
            const p = produse.find(x => x.id == id);
            editId = id;
            document.getElementById("denumire").value = p.denumire;
            document.getElementById("pret").value = p.pret;
            document.getElementById("descriere").value = p.descriere;
            document.getElementById("cantitate").value = p.cantitate;
            document.getElementById("sloiuri").value = p.sloiuri.join(", ");
        }

        // upload imagine local + returneaza link relativ
        async function uploadImagineLocal(file) {
            const formData = new FormData();
            formData.append("file", file);

            const res = await fetch("http://127.0.0.1:3000/uploadProdus", {
                method: "POST",
                body: formData
            });
            const data = await res.json();
            return `pozeProduse/${data.path.split("/").pop()}`;
        }

        // submit formular
        document.getElementById("prodForm").addEventListener("submit", async e => {
            e.preventDefault();

            const file = document.getElementById("imagine").files[0];
            let linkImagine = "";

            if (file) {
                linkImagine = await uploadImagineLocal(file);
            } else if (editId) {
                linkImagine = produse.find(p => p.id == editId).imagine;
            } else {
                alert("Trebuie să alegi o imagine!");
                return;
            }

            const denumire = document.getElementById("denumire").value;
            const pret = parseFloat(document.getElementById("pret").value);
            const descriere = document.getElementById("descriere").value;
            const cantitate = parseFloat(document.getElementById("cantitate").value);
            const sloiuri = document.getElementById("sloiuri").value.split(",").map(s => s.trim());

            const res = await fetch(WEBAPP_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    action: editId ? "editeaza" : "adauga",
                    id: editId,
                    imagine: linkImagine,
                    denumire,
                    pret,
                    descriere,
                    cantitate,
                    sloiuri
                })
            });
            await res.json();

            e.target.reset();
            editId = null;
            incarcaProduse();
        });

        incarcaProduse();
    </script>

</body>

</html>